(()=>{var e={84:e=>{"use strict";e.exports=require("mssql")},124:e=>{"use strict";e.exports=require("winston")},241:e=>{"use strict";e.exports=require("qrcode-terminal")},242:(e,t,s)=>{const a=s(124),r=a.createLogger({level:"info",format:a.format.combine(a.format.timestamp(),a.format.json()),transports:[new a.transports.File({filename:"error.log",level:"error"}),new a.transports.File({filename:"combined.log"})]});e.exports=r},425:(e,t,s)=>{const{sql:a,poolPromise:r}=s(835),n={PENDING:0,SUCCESS:1,FAILED_NOT_REGISTERED:2};t.readScheduleMessage=async()=>{const e=await r,t=parseInt(process.env.MESSAGE_BATCH_SIZE,10)||10;return(await e.request().input("DeliveryStatus",a.TinyInt,n.PENDING).input("WorkHourStart",a.Int,process.env.WORK_HOUR_START||10).input("WorkHourEnd",a.Int,process.env.WORK_HOUR_END||19).input("BatchSize",a.Int,t).query("SELECT top (@BatchSize) *\n                FROM dbo.WP_MessgeSchedule \n                WHERE ScheduleDate <= getdate() \n                  AND DATEPART(HOUR, GETDATE()) BETWEEN @WorkHourStart AND @WorkHourEnd \n                  AND DeliveryStatus = @DeliveryStatus \n                ORDER BY ScheduleId DESC")).recordset},t.updateDeliveryStatus=async(e,t,s)=>{const n=await r;return(await n.request().input("ScheduleId",a.Int,e).input("DeliveryStatus",a.TinyInt,t).input("Status",a.NVarChar(1e3),s).query("UPDATE WP_MessgeSchedule \n                SET DeliveryStatus = @DeliveryStatus, \n                    DeliveryDate = GETDATE(), \n                    Status = @Status \n                WHERE ScheduleId = @ScheduleId")).rowsAffected},t.logIncomingMessage=async(e,t)=>{const s=await r;return(await s.request().input("WhatsappNo",a.NVarChar(50),e).input("MessageBody",a.NVarChar(a.MAX),t).query("INSERT INTO dbo.WP_IncomingMessages (WhatsappNo, MessageBody)\n                VALUES (@WhatsappNo, @MessageBody)")).rowsAffected},t.MESSAGE_STATUS=n},434:e=>{"use strict";e.exports=require("whatsapp-web.js")},527:(e,t,s)=>{const a=s(904),{MessageMedia:r}=s(434),n=s(242),o=s(425),{client:i}=s(958);async function c(e){try{if(await i.isRegisteredUser(e.WhatsappNo)){const t=await i.getNumberId(e.WhatsappNo);let s=!1;if(e.Attachment&&e.FileName){const o=a.lookup(e.FileName);if(o){const a=new r(o,e.Attachment,e.FileName);await i.sendMessage(t._serialized,a),s=!0}else n.warn(`Could not determine MIME type for ${e.FileName}. Attachment skipped.`,{ScheduleId:e.ScheduleId})}e.MessageText&&(await i.sendMessage(t._serialized,e.MessageText),s=!0),s&&(await o.updateDeliveryStatus(e.ScheduleId,o.MESSAGE_STATUS.SUCCESS,"Successful"),n.info(`Successfully sent message ScheduleId: ${e.ScheduleId}`))}else await o.updateDeliveryStatus(e.ScheduleId,o.MESSAGE_STATUS.FAILED_NOT_REGISTERED,"Not registered on WhatsApp"),n.warn("Message failed. Recipient not registered on WhatsApp.",{ScheduleId:e.ScheduleId,WhatsappNo:e.WhatsappNo})}catch(t){n.error(`Failed to process message ScheduleId: ${e.ScheduleId}.`,t);try{await o.updateDeliveryStatus(e.ScheduleId,o.MESSAGE_STATUS.FAILED_NOT_REGISTERED,"Processing Failed")}catch(t){n.error(`Failed to update status for failed message ScheduleId: ${e.ScheduleId}.`,t)}}}const l=process.env.POLLING_INTERVAL_MS||1e4;let u;async function d(){try{await async function(){try{const e=await o.readScheduleMessage();e.length>0&&(n.info(`Found ${e.length} message(s) to send.`),await Promise.all(e.map(c)))}catch(e){n.error("Error fetching and processing scheduled messages:",e)}}()}catch(e){n.error("An unexpected error occurred in the scheduler:",e)}finally{u=setTimeout(d,l)}}e.exports={start:function(){n.info(`Scheduler starting. Polling interval: ${l}ms.`),d()},stop:function(){u&&(clearTimeout(u),n.info("Scheduler stopped."))}}},818:e=>{"use strict";e.exports=require("dotenv")},835:(e,t,s)=>{s(818).config();const a=s(84),r=s(242),n={server:process.env.DB_SERVER,user:process.env.DB_USER,password:process.env.DB_PASSWORD,database:process.env.DB_DATABASE,options:{encrypt:!0,trustServerCertificate:!1}},o=new a.ConnectionPool(n).connect().then(e=>(r.info("Connected to SQLServer..."),e.on("error",e=>{r.error("SQL Pool Error",e)}),e)).catch(e=>{r.error("Database Connection Failed! Bad Config: ",e),process.exit(1)});e.exports={sql:a,poolPromise:o,close:async()=>{try{const e=await o;e&&(await e.close(),r.info("Database connection pool closed."))}catch(e){r.error("Error closing database pool",e)}}}},904:e=>{"use strict";e.exports=require("mime-types")},958:(e,t,s)=>{const{Client:a,LocalAuth:r}=s(434),n=s(241),o=s(242),i=s(425),c=new a({authStrategy:new r,puppeteer:{headless:"false"!==process.env.PUPPETEER_HEADLESS}});e.exports={client:c,initialize:function(){o.info("Initializing WhatsApp client..."),c.on("loading_screen",(e,t)=>{o.info(`LOADING SCREEN: ${e}% ${t}`)}),c.on("qr",e=>{n.generate(e,{small:!0}),o.info("QR Code received, please scan.")}),c.on("authenticated",()=>{o.info("Client authenticated successfully.")}),c.on("auth_failure",e=>{o.error("Authentication failed.",{message:e})}),c.on("ready",async()=>{o.info("WhatsApp client is ready!");const e=await c.getWWebVersion();o.info(`WWebVersion = ${e}`)}),c.on("message",async e=>{try{const t=await e.getChat(),s=await e.getContact(),a=e.body.replace(/[^\w\s.,!?-]/g,""),r=process.env.DEFAULT_REPLY_MESSAGE||"Thank you for your message.";await t.sendMessage(r),await i.logIncomingMessage(s.id.user,a)}catch(e){o.error("Failed to process incoming message:",e)}}),c.on("disconnected",e=>{o.warn("Client was logged out.",{reason:e})}),c.initialize()}}}},t={};function s(a){var r=t[a];if(void 0!==r)return r.exports;var n=t[a]={exports:{}};return e[a](n,n.exports,s),n.exports}const a=s(242),r=s(835),n=s(527),o=s(958),i=async e=>{a.info(`Caught ${e}. Shutting down gracefully...`);try{n.stop(),await o.client.destroy(),a.info("WhatsApp client destroyed."),await r.close()}catch(e){a.error("Error during graceful shutdown",e)}finally{process.exit(0)}};process.on("SIGINT",()=>i("SIGINT")),process.on("SIGTERM",()=>i("SIGTERM")),a.info("Application starting..."),o.initialize(),o.client.on("ready",()=>{n.start()})})();